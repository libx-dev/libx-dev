name: Deploy to Staging

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  push:
    branches:
      - staging
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      skip_lighthouse:
        description: 'Skip Lighthouse checks'
        required: false
        default: 'false'

jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
  pre-deployment-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ãƒã‚§ãƒƒã‚¯1: Lint
      - name: Run lint
        run: pnpm lint
        continue-on-error: false

      # ãƒã‚§ãƒƒã‚¯2: Format
      - name: Check format
        run: pnpm prettier --check .
        continue-on-error: true

      # ãƒã‚§ãƒƒã‚¯3: ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      - name: Validate registry
        run: pnpm validate
        continue-on-error: false

      # ãƒã‚§ãƒƒã‚¯4: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run tests
        run: pnpm test:coverage
        continue-on-error: false

      # ãƒã‚§ãƒƒã‚¯5: ã‚µã‚¤ãƒ‰ãƒãƒ¼JSONç”Ÿæˆ
      - name: Build sidebar
        run: pnpm build:sidebar

      - name: Check sidebar files
        run: |
          echo "Checking sidebar JSON files..."
          find apps/*/src/generated -name "sidebar-*.json" -type f || echo "No sidebar files found"

  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-staging:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    timeout-minutes: 30
    environment:
      name: staging
      url: https://libx-staging.pages.dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build sidebar
        run: pnpm build:sidebar

      - name: Build project
        run: pnpm build
        timeout-minutes: 10

      - name: Check build output
        run: |
          echo "Build output size:"
          du -sh dist/
          echo ""
          echo "HTML files count:"
          find dist/ -name "*.html" | wc -l
          echo ""
          echo "Directory structure:"
          tree -L 3 -d dist/ || ls -laR dist/

      - name: Deploy to Cloudflare Pages (Staging)
        uses: cloudflare/pages-action@v1
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: libx-staging
          directory: dist
          branch: staging

      - name: Record deployment info
        run: |
          echo "Deployment URL: ${{ steps.deploy.outputs.url }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.id }}"
          echo "Environment: staging"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment deployment success
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.url }}';
            const message = `### âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ

            **ãƒ‡ãƒ—ãƒ­ã‚¤URL**: ${deployUrl}
            **ãƒ–ãƒ©ãƒ³ãƒ**: staging
            **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: ${new Date().toISOString()}

            **å‹•ä½œç¢ºèªé …ç›®**:
            - [ ] å…¨ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
            - [ ] ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª
            - [ ] æ¤œç´¢æ©Ÿèƒ½å‹•ä½œç¢ºèª
            - [ ] è¨€èªåˆ‡æ›¿å‹•ä½œç¢ºèª
            - [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡æ›¿å‹•ä½œç¢ºèª
            `;

            // æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });

  # Lighthouseã‚¹ã‚³ã‚¢æ¸¬å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  lighthouse-check:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.skip_lighthouse != 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for Lighthouse
        run: pnpm build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.15.x lighthouse chrome-launcher

      - name: Start server
        run: |
          cd apps/demo-docs
          pnpm preview --port 4321 &
          sleep 10

      - name: Run Lighthouse CI (demo-docs)
        run: |
          cd apps/demo-docs
          lhci autorun || echo "Lighthouse CI completed with warnings"
        continue-on-error: true

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-staging
          path: |
            apps/demo-docs/.lighthouseci
            apps/sample-docs/.lighthouseci
          retention-days: 30

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç…™ãƒ†ã‚¹ãƒˆ
  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 10

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check staging site accessibility
        run: |
          STAGING_URL="https://libx-staging.pages.dev"

          echo "Checking staging site..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/v1/en/getting-started/")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Staging site is accessible (HTTP $HTTP_CODE)"
          else
            echo "âŒ Staging site returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Check Japanese version
        run: |
          STAGING_URL="https://libx-staging.pages.dev"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/v1/ja/getting-started/")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Japanese version is accessible (HTTP $HTTP_CODE)"
          else
            echo "âŒ Japanese version returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Report smoke test results
        if: always()
        run: |
          echo "### ğŸ§ª Smoke Test Results"
          echo ""
          echo "All basic accessibility checks passed."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
