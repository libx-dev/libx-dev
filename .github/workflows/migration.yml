name: Migration Workflow

# ç§»è¡Œä½œæ¥­ç”¨ã®CI/è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Phase 3-4ã§å®Ÿè£…ã•ã‚ŒãŸæ–°CLIã‚³ãƒžãƒ³ãƒ‰ã¨äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæŸ”è»Ÿãªå®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰
  workflow_dispatch:
    inputs:
      project:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDï¼ˆä¾‹: sample-docsï¼‰'
        required: false
        default: ''
      version:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDï¼ˆä¾‹: v1ï¼‰'
        required: false
        default: ''
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆnew-cli: æ–°CLIä½¿ç”¨, compat: äº’æ›ãƒ©ãƒƒãƒ‘ãƒ¼ä½¿ç”¨ï¼‰'
        required: true
        type: choice
        options:
          - new-cli
          - compat
        default: new-cli
      dry-run:
        description: 'Dry-runãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ã‚’å®Ÿéš›ã«ã¯è¡Œã‚ãªã„ï¼‰'
        type: boolean
        default: true

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼ˆæ¤œè¨¼ã®ã¿ï¼‰
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/migration.yml'
      - '.docs-cli/**'
      - 'packages/cli/**'
      - 'scripts/compat/**'

jobs:
  # äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
  compatibility-check:
    runs-on: ubuntu-latest
    outputs:
      has-warnings: ${{ steps.compat-check.outputs.has-warnings }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: äº’æ›æ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        id: compat-check
        run: |
          # äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          pnpm exec docs-cli compat check --no-schedule --no-guide > compat-check.log 2>&1 || true

          # è­¦å‘Šã®æœ‰ç„¡ã‚’ç¢ºèª
          if grep -q 'WARNING\|âš ï¸' compat-check.log; then
            echo "has-warnings=true" >> $GITHUB_OUTPUT
          else
            echo "has-warnings=false" >> $GITHUB_OUTPUT
          fi

          # ãƒ­ã‚°ã‚’è¡¨ç¤º
          cat compat-check.log

      - name: äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ãƒ­ã‚°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compat-check-log
          path: compat-check.log
          retention-days: 7

  # ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  migration-report:
    runs-on: ubuntu-latest
    needs: compatibility-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          # ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p reports/migration

          # ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          pnpm exec docs-cli compat report --output reports/migration

      - name: ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: migration-reports
          path: |
            reports/migration/
          retention-days: 30

  # æ–°CLIä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰
  migrate-new-cli:
    runs-on: ubuntu-latest
    needs: compatibility-check
    if: github.event.inputs.mode == 'new-cli' || github.event.inputs.mode == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        run: |
          # CIç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ -f .docs-cli/config.ci.json ]; then
            echo "âœ… CIç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            cat .docs-cli/config.ci.json
          else
            echo "âš ï¸  CIç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
          fi

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆãƒ‡ãƒ¢ï¼‰
        if: github.event.inputs.project != ''
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          PROJECT_ID="${{ github.event.inputs.project }}"

          # Dry-runãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ --dry-run ã‚’ä»˜ä¸Ž
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: $PROJECT_ID (dry-run: ${{ github.event.inputs.dry-run }})"
          pnpm exec docs-cli add project "$PROJECT_ID" \
            --display-name-en "$PROJECT_ID" \
            --display-name-ja "$PROJECT_ID" \
            $DRY_RUN_FLAG || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ï¼‰"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ ï¼ˆãƒ‡ãƒ¢ï¼‰
        if: github.event.inputs.project != '' && github.event.inputs.version != ''
        run: |
          PROJECT_ID="${{ github.event.inputs.project }}"
          VERSION_ID="${{ github.event.inputs.version }}"

          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ : $PROJECT_ID/$VERSION_ID (dry-run: ${{ github.event.inputs.dry-run }})"
          pnpm exec docs-cli add version "$PROJECT_ID" "$VERSION_ID" \
            $DRY_RUN_FLAG || echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ï¼‰"

      - name: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        run: |
          echo "ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          pnpm validate || echo "âš ï¸  ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        if: github.event.inputs.dry-run != 'true'
        run: |
          echo "ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”Ÿæˆä¸­..."
          pnpm build:sidebar

          echo "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œä¸­..."
          pnpm build

      - name: ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always() && github.event.inputs.dry-run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-new-cli
          path: |
            logs/
            .backups/
          retention-days: 7

  # äº’æ›ãƒ©ãƒƒãƒ‘ãƒ¼ä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰
  migrate-compat:
    runs-on: ubuntu-latest
    needs: compatibility-check
    if: github.event.inputs.mode == 'compat'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: äº’æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç¢ºèª
        run: |
          if [ -d scripts/compat ]; then
            echo "âœ… äº’æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            ls -la scripts/compat/
          else
            echo "âŒ äº’æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰
        if: github.event.inputs.project != ''
        run: |
          PROJECT_ID="${{ github.event.inputs.project }}"

          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰: $PROJECT_ID"
          node scripts/compat/create-project.js "$PROJECT_ID" "$PROJECT_ID" "$PROJECT_ID" \
            --suppress-warning || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—"

      - name: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        run: |
          pnpm validate || echo "âš ï¸  ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        if: github.event.inputs.dry-run != 'true'
        run: |
          pnpm build:sidebar
          pnpm build

      - name: ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always() && github.event.inputs.dry-run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-compat
          path: |
            logs/
            .backups/
          retention-days: 7

  # é€šçŸ¥ï¼ˆäº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: compatibility-check
    if: needs.compatibility-check.outputs.has-warnings == 'true' && github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: è­¦å‘Šé€šçŸ¥ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## âš ï¸ äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ç§»è¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‹ã‚‰ \`compat-check-log\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦è­¦å‘Šå†…å®¹ã‚’æŠŠæ¡
            3. å¿…è¦ã«å¿œã˜ã¦äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½¿ç”¨ã‚’æ¤œè¨Ž

            ### å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - [äº’æ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¬ã‚¤ãƒ‰](docs/new-generator-plan/guides/compat-layer.md)
            - [Phase 3-4è¨ˆç”»](docs/new-generator-plan/phase-3-4-ci-automation.md)

            **ã‚µãƒãƒ¼ãƒˆçµ‚äº†æ—¥**: 2026-03-31
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # ã‚µãƒžãƒªãƒ¼
  summary:
    runs-on: ubuntu-latest
    needs: [compatibility-check, migration-report, migrate-new-cli, migrate-compat]
    if: always()
    steps:
      - name: ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
        run: |
          echo "## ðŸŽ¯ Migration Workflow ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${{ github.event.inputs.project || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ github.event.inputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.mode || 'new-cli' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry-run: ${{ github.event.inputs.dry-run || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### äº’æ›æ€§ãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- è­¦å‘Šæ¤œå‡º: ${{ needs.compatibility-check.outputs.has-warnings }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ãƒ­ã‚°: \`compat-check-log\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆ: \`migration-reports\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry-run }}" != "true" ]; then
            echo "- ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°: \`build-logs-*\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "1. Artifactsã‹ã‚‰ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
          echo "2. ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ã®èª¿æ•´ã‚’å®Ÿæ–½" >> $GITHUB_STEP_SUMMARY
