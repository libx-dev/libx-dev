# 新ドキュメントサイトジェネレーター計画書（草案）

## 1. 背景
- libx-dev は Astro ベースのモノレポ構造と三リポジトリ連携（libx-dev/libx-core/libx-docs）によって柔軟性を確保してきたが、運用コスト・自動化スクリプトの複雑性・統合ビルドの多段化が課題になっている。
- 新プロダクトでは、libx-dev の成果物（UI コンポーネント、テーマ、ビルドノウハウ、多言語対応モデル）を活かしつつ、単一リポジトリ・単一ビルドで完結するシンプルなジェネレーターを目指す。

## 2. ゴールと非ゴール
### ゴール
- ドキュメント作者が JSON/CLI ベースのワークフローでコンテンツを追加できる単一リポジトリのジェネレーターを提供する。
- Astro を中心とした既存技術スタックを活かしながら、最終的な統合サイトを 1 回のビルドで生成できるようにする。
- 翻訳・バージョン管理・共有テーマといった libx-dev の知見を継承し、Cloudflare Pages でのデプロイを想定したパイプラインを構築する。

### 非ゴール
- Astro から別フレームワークへの移行は想定しない（調査は行うが採用は必須ではない）。
- 翻訳支援や CMS の完全オンライン化は本計画の範囲外（将来拡張候補とする）。

## 3. 現状評価（libx-dev の強みと課題）
### 活かしたい強み
- 高品質な UI/テーマパッケージ群（@docs/ui, @docs/theme など）と Starlight 系 UX。
- 翻訳ワークフローと多言語・バージョン対応の実績。
- Cloudflare Pages を前提にしたビルド／デプロイ知識。
- サイドバー生成や構造検証のためのスクリプト資産。

### 解消すべき課題
- モノレポ＋ pnpm ワークスペースによる依存管理・ビルド制御の複雑さ。
- libx-dev/libx-core/libx-docs の三分割運用と同期コスト。
- ファイル階層（01-〜、言語ディレクトリ）前提のスクリプト乱立と手動操作の多さ。
- 各アプリの個別ビルド→統合ビルドという二段構成による長時間ビルド。

## 4. 新プロダクトの基本方針
1. **単一リポジトリ構造**: `src/` に Astro のランタイム、`registry/` にサイト構造定義、`content/` に本文をまとめ、pnpm ワークスペースは廃止する。
2. **データ駆動アプローチ**: プロジェクト・カテゴリ・バージョン情報を JSON スキーマで管理し、CLI から操作できるようにする。本文は docId 単位で格納し、メタ情報をレジストリに集約。
3. **単一ビルド**: レジストリを読み込む Astro ビルドを設計し、従来の統合ビルドを一回で再現する。ルーティング生成・サイドバー生成・サイトマップ生成もビルド時に自動化。
4. **既存資産の再利用**: `@docs/ui` 等を抽出して独立パッケージ化（npm 公開またはサブモジュール化）し、新ジェネレーターから取り込む。
5. **CLI 中心の運用**: `docs-cli`（仮称）でプロジェクト作成、バージョン追加、言語追加、ドキュメント登録、libx-dev からの移行を実行可能にし、手動スクリプト操作を排除。

## 5. アーキテクチャ構想
### 5.1 ディレクトリ構造（案）
```
new-docs-generator/
├── src/
│   ├── runtime/         # Astro レイアウト・ページ・API
│   ├── components/      # 再利用 UI ラッパー
│   └── generator/       # レジストリ読み込み・ルーティング生成ロジック
├── registry/
│   ├── docs.schema.json # JSON スキーマ
│   └── projects/*.json  # プロジェクト定義（バージョン・メニュー・ライセンス等）
├── content/
│   └── <docId>/
│       ├── en.mdx
│       └── ja.mdx
├── tools/
│   └── docs-cli/        # CLI/テンプレート
└── integration/
    └── tests/           # バリデーション・リンクチェック
```

### 5.2 コアコンポーネント
- **Registry Loader**: JSON スキーマをバリデーションし、Astro のエントリポイントへ提供するモジュール。
- **Content Resolver**: `docId` と言語をキーに MDX を読み込み、フロントマターを利用して翻訳情報やタグを注入。
- **Navigation Builder**: プロジェクト定義からサイドバー・パンくず・バージョンスイッチャーを生成。
- **Search Indexer**: コンテンツから検索インデックス（例: Algolia 形式）を生成する拡張ポイント。
- **CLI サブコマンド**: `create-project`, `add-version`, `add-language`, `add-doc`, `migrate-from-libx`, `validate` などを提供。
- **CI パイプライン**: スキーマバリデーション、リンク切れ検出、翻訳整合チェック、ビルド検証を GitHub Actions 等で自動化。

## 6. 移行戦略
- **パッケージ抽出**: `packages/ui` などを個別モジュールとして切り出し、新ジェネレーターから npm 依存または Git submodule で参照可能にする。
- **設定変換スクリプト**: 既存 `project.config.json` や `projects.config.json` を新レジストリ形式へ変換する CLI サブコマンドを用意。
- **MDX マイグレーション**: 現在のファイル命名（`01-...`）を解析し、`docId` とカテゴリ情報を JSON レジストリへ登録する変換ツールを提供。
- **互換レイヤー**: 旧スクリプト呼び出しを新 CLI にリダイレクトするラッパーを用意し、既存運用との共存期間を確保。
- **段階的移行**: libx-dev の一部プロジェクトを先行移行し、フィードバックを反映させながら全移行を計画。

## 7. ロードマップ
| フェーズ | 期間目安 | 主要アウトプット | 主なタスク |
|----------|----------|------------------|-------------|
| フェーズ0: 企画固め | 2週間 | 要件ブリーフ、データモデル草案 | 関係者ヒアリング、レジストリ項目確定、既存資産棚卸し |
| フェーズ1: コア基盤 | 3週間 | JSON スキーマ、CLI α版 | レジストリスキーマ設計、基本 CLI コマンド実装、バリデーション実装 |
| フェーズ2: ビルド実装 | 4週間 | Astro ビルダー β版 | ランタイム構築、UI/テーマ統合、単一ビルドパイプライン構築 |
| フェーズ3: 移行準備 | 3週間 | マイグレーションツール、CI 基盤 | 設定／MDX 変換スクリプト、互換レイヤー、CI テンプレ整備 |
| フェーズ4: QA/リリース | 2週間 | リリース候補、運用ガイド | アクセシビリティ/リンクチェック、Cloudflare Pages デプロイ検証、ドキュメント整備 |
| フェーズ5: 継続改善 | 継続 | フィードバック反映 | 翻訳ワークフロー連携検討、テーマ拡張、監視指標設計 |

## 8. リスクと対策
- **スキーマ複雑化**: 必須項目を最小限にし、拡張フィールドはオプション扱いとする。CLI でテンプレート生成を徹底し入力ミスを防ぐ。
- **UI/テーマ抽出の工数**: 先に依存関係やビルドツールの整理を行い、抽出対象を段階的に切り出す。互換レイヤーを設け既存リポジトリからの参照も維持する。
- **移行期間の運用負荷**: 新旧両方のビルドを一時的に走らせ、移行チェックリストと自動テストで差異を検出する。
- **翻訳整合性確保**: レジストリに翻訳ステータスを持たせ、未翻訳やレビュー待ちを CLI が検出できるようにする。

## 9. 今後のアクション（次のステップ）
1. 関係者へのヒアリングを実施し、レジストリで管理すべきメタ情報と CLI ユースケースを確定する。
2. `@docs/ui` など共有パッケージの抽出と公開形態（npm / Git submodule）の方針を決め、PoC を用意する。
3. JSON スキーマと CLI プロトタイプの仕様書を作成し、フェーズ1 の実装タスクを詳細化する。

---
本計画書は初期草案であり、フェーズ進行に合わせて定期的に見直す想定である。
