# 決定事項ログ

フェーズ0までに合意された主要な意思決定を記録します。新しい決定は追記し、参照した文書や目的を明示してください。

## 2024-XX-XX 新ジェネレーター基盤に関する合意

1. **レジストリ構造の扱い**  
   - 初期版は単一 JSON で構成し、プロジェクト単位の分割はフェーズ1終盤に再評価する。  
   - 根拠: フェーズ0 要件ブリーフ / registry-metadata。シンプルなソース・オブ・トゥルース維持と原則4（コンテンツ運用）との整合。

2. **検索エンジン方針**  
   - 初期実装は Pagefind を標準とし、Algolia 等の外部サービスはフェーズ2以降の拡張候補として比較検証する。  
   - 根拠: 競合調査、原則5（自動化と品質保証）。

3. **libx-docs リポジトリの取り扱い**  
   - 移行期間中はソース置き場として維持し、フェーズ3完了時に継続是非を見直すマイルストーンを設定する。  
   - 根拠: asset-inventory、原則6（コラボレーションとナレッジ共有）。

4. **共有パッケージ配布形態**  
   - 第一候補は npm 公開可能なパッケージ化。移行期間中は Git サブモジュール活用もバックアップ案として保持し、フェーズ1で PoC を行う。  
   - 根拠: UI/テーマ調査、原則2（共有資産の最大活用）。

5. **翻訳ステータス管理**  
   - レジストリに `status`, `lastUpdated`, `reviewer` などのフィールドを追加し CLI `validate`/`info` で可視化する。  
   - 根拠: requirements-brief、原則4（コンテンツ運用）。

6. **検索・ナビゲーションメタデータ**  
   - `documents` に `keywords`, `tags`, `related` を保持し、MDX frontmatter は最小化。高度な関連付けはフェーズ5以降で検討する。  
   - 根拠: registry-metadata、原則3・4。

7. **CLI バックアップ/ロールバック戦略**  
   - 既存スクリプト同様 `.backups/` に差分保存し、失敗時自動ロールバックを標準化。バックアップの保有期間とクリーンアップコマンドを設ける。  
   - 根拠: scripts 調査、原則5（信頼性）。

8. **CI/自動化カバレッジ**  
   - フェーズ1で JSON Schema 検証・レジストリ/コンテンツ整合・Astro ビルドを必須にし、フェーズ2でリンク・アクセシビリティ・翻訳整合検査を追加する段階計画を採用。  
   - 根拠: requirements-brief、原則5。

---

## 2025-10-16 スキーマ v1.0.0 承認

### 承認内容

**レジストリスキーマ v1.0.0** を正式承認し、フェーズ1-1（レジストリスキーマ詳細計画）を完了とする。

### 成果物

1. **スキーマファイル群**
   - `registry/docs.schema.json` - ルートスキーマ（JSON Schema Draft 2020-12）
   - `registry/schema/project.schema.json` - プロジェクト定義
   - `registry/schema/document.schema.json` - ドキュメントエントリ定義
   - `registry/schema/category.schema.json` - カテゴリ構造定義
   - `registry/schema/language.schema.json` - 言語設定定義
   - `registry/schema/version.schema.json` - バージョン設定定義
   - `registry/schema/settings.schema.json` - グローバル設定定義
   - `registry/schema/partials/*.schema.json` - 共通定義（contributor, glossary, license, document-content, common）

2. **ドキュメント**
   - `registry/schema/CHANGELOG.md` - スキーマ変更履歴と変更プロセス
   - `registry/schema/VERSIONING.md` - バージョニングガイドとSemVerルール

3. **バリデーションツール**
   - `scripts/validate-schema.js` - スキーマ整合性チェックツール
   - `registry/examples/sample-basic.json` - サンプルデータ

### 主要な設計判断

#### 1. スキーマモジュール化方針

**決定**: エンティティ単位（project, document, category等）でスキーマを分割し、`$ref`で参照する構造を採用。

**根拠**:
- 保守性の向上：各エンティティを独立して編集可能
- 再利用性：共通定義（partials）を複数箇所から参照
- 段階的な拡張：将来的なプロジェクト単位ファイル分割への準備

**代替案検討**:
- 単一巨大スキーマ：シンプルだが保守性が低い
- 完全分散（プロジェクト単位）：複雑すぎる、フェーズ1では不要

#### 2. バージョニングポリシー

**決定**: Semantic Versioning (SemVer) を採用し、`$schemaVersion`フィールドでバージョン管理。

**根拠**:
- 業界標準：JSON Schemaの一般的なプラクティスに準拠
- 互換性管理：MAJOR/MINOR/PATCHの明確な基準で破壊的変更を識別
- マイグレーション計画：バージョン間の移行パスを明示的に管理

**運用ルール**:
- MAJOR: 後方互換性のない変更（必須フィールド追加、フィールド削除など）
- MINOR: 後方互換性のある機能追加（任意フィールド追加、enum値追加など）
- PATCH: バグ修正、ドキュメント改善

#### 3. バリデーション戦略の分離

**決定**: 基本的な型・形式チェックはJSON Schemaで実施し、参照整合性などの高度なチェックはCLI側で実装。

**根拠**:
- JSON Schemaの限界：言語/バージョン/ライセンスIDの存在チェックなど、クロスリファレンス検証は困難
- 役割分担：スキーマは構造定義に集中、CLIは業務ロジック検証を担当
- エラーメッセージ：CLI側で日本語の分かりやすいエラーメッセージを提供可能

**実装計画**:
- フェーズ1-1: スキーマ定義とbasicバリデーション
- フェーズ1-2: CLIでの参照整合性チェック実装
- フェーズ1-3: strictモードでのビジネスルール検証

#### 4. 拡張性の確保

**決定**: 将来の機能追加に備え、一部フィールドで`additionalProperties: true`を許可。

**対象フィールド**:
- `metadata`: レジストリ生成日時、担当者などの運用メタデータ
- `options`: プロジェクト固有のカスタム設定
- `toc`, `hero`: UI実装時に詳細仕様を確定するフィールド

**根拠**:
- フェーズ間の柔軟性：UI設計（フェーズ2）やマイグレーション（フェーズ3）で新要件が発生する可能性
- 段階的な厳密化：必要に応じて後のMINORバージョンで制約を追加可能

### バリデーション結果

**実施日**: 2025-10-16
**ツール**: `scripts/validate-schema.js`

**チェック項目**:
- ✅ 全スキーマファイルが有効なJSON
- ✅ ルートスキーマの基本構造が正常
- ✅ $ref参照の整合性確認
- ✅ サンプルデータの基本構造検証

**注記**: 完全なAjvベースのスキーマバリデーションはCLI実装時（フェーズ1-2）に統合予定。

### 今後の対応

1. **フェーズ1-2への移行**
   - CLIバリデーションコマンドの実装
   - Ajv統合と参照整合性チェック
   - エラーメッセージの日本語化

2. **レジストリデータの初期作成**
   - 既存プロジェクト（sample-docs, test-verification等）のマッピング
   - マイグレーションスクリプトの設計

3. **ステークホルダーレビュー**
   - CLI担当者: バリデーションインターフェース確認
   - ジェネレーター担当者: ビルド時のデータ消費方法確認
   - コンテンツ担当者: フィールド要件の最終確認

### 参照ドキュメント

- [フェーズ1-1計画](./phase-1-1-registry-schema.md)
- [スキーマ変更履歴](../../registry/schema/CHANGELOG.md)
- [バージョニングガイド](../../registry/schema/VERSIONING.md)

---

次回更新予定: フェーズ1-2開始時に新たな意思決定があれば追記します。
