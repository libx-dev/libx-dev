# フェーズ2-3：検索機能詳細計画

## 目的
- Pagefind を標準検索エンジンとして導入し、レジストリで管理する `keywords`, `tags`, `related`, `visibility` 情報を検索体験に反映する。
- 検索 UI と API を整備し、将来的な外部検索サービス（Algolia 等）と置き換え／併用できる拡張ポイントを確保する。

## スコープ
- Pagefind インデックス生成スクリプトとビルドパイプラインへの統合。
- 検索結果 UI（結果一覧、キーワードハイライト、タグ表示、言語/バージョンフィルタ）。
- 検索品質チューニング（除外パス、重み付け、同義語、ゼロヒット対策）。

## タスク
1. **Pagefind 導入**
   - `pnpm build` の postbuild フェーズで `pagefind` CLI を実行。  
   - `dist/pagefind/` を生成し、Cloudflare Pages で配信できるよう設定。
2. **メタデータ拡張**
   - Pagefind の metadata API に `tags`, `language`, `version`, `project` 等を渡す。  
   - Glossary 用語も検索対象に含め、結果に表示するテンプレートを整備。
3. **検索 UI 実装**
   - クライアントサイドで Pagefind と連携するコンポーネントを実装。  
   - フィルタ（プロジェクト、バージョン、言語、タグ）とソート（関連度、新着）を提供。
4. **品質チューニング**
   - 除外パス設定（`/draft/`、`/internal/` を除外）。  
   - 同義語辞書、ストップワード設定、リッチスニペット生成を検討。  
   - 検索ログ用イベント（検索語、結果件数）を収集できるようにする。
5. **テストと検証**
   - 代表キーワードによる検索結果のスナップショットテスト。  
   - ゼロヒットキーワード一覧を抽出し、Glossary/タグの改善にフィードバック。  
   - Lighthouse / Web Vitals への影響を測定。
6. **ドキュメント**
   - `docs/new-generator-plan/guides/search.md` に設定手順、メタデータ仕様、チューニング方法をまとめる。  
   - Pagefind の制約と外部サービス切り替え時の考慮点を記載。

## 成果物
- Pagefind インデックス生成スクリプトと設定ファイル。
- 検索 UI コンポーネント、フィルタ/ソート機能。
- 検索品質レポートとログ収集仕組み。
- 検索ガイドドキュメント。

## 完了条件
- ビルド結果に検索インデックスが含まれ、Cloudflare Pages 上で検索が機能する。
- 代表的なクエリで期待通りの結果が得られ、ゼロヒット率が許容範囲に収まる。
- 検索設定がドキュメント化され、今後のチューニングや外部サービス移行に備えられる。
