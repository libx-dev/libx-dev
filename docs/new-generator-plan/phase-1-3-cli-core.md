# フェーズ1-3：CLI 基盤詳細計画

## 目的
- `docs-cli` をプロジェクトのメイン操作インターフェースとして確立し、フェーズ2以降のビルド・移行・運用タスクを統合する。
- 冪等性とロールバック性を担保する共通ユーティリティを整備し、スクリプト乱立から CLI 集約へ移行する土台を作る。

## スコープ
- CLI エントリポイント設計、コマンド構成、オプション規約。
- `add-project`, `add-version`, `add-language`, `add-doc`, `migrate-from-libx`（骨組み）, `validate` の実装。
- バックアップ (`.backups/`)、ログ出力、設定読み込み、エラー処理の共通ユーティリティ。
- `.docs-cli/config.json` と環境変数の優先順位ルール。

## タスク
1. **CLI 設計と足回り**
   - Commander.js（候補）をベースに、共通フラグ（`--config`, `--dry-run`, `--verbose`, `--json`）を定義。  
   - コマンド実行前後のフック処理（バリデーション、バックアップ、ロールバック）を共通化。
2. **バックアップ/ロールバックユーティリティ**
   - 変更対象ファイルを自動検出し、`.backups/<timestamp>/<path>` に保存。  
   - 失敗時に自動復元、成功時は必要に応じてローテーション。  
   - エクスポート可能なバックアップ管理 API を用意し、フェーズ3の移行ツールでも利用。
3. **設定読み込み**
   - `.docs-cli/config.json` をデフォルトとし、環境変数 `DOCS_CLI_CONFIG` 指定時は上書き。  
   - CI 用に非対話モード設定（例: `nonInteractive: true`）をサポート。
4. **主要コマンド実装**
   - `add-project`: レジストリ追加、content ディレクトリ生成、テンプレート MDX 作成。  
   - `add-version`: 既存バージョンコピー or 空ディレクトリ生成、レジストリ更新。  
   - `add-language`: ディレクトリ作成、翻訳テンプレ、ステータス初期化。  
   - `add-doc`: docId 採番、MDX テンプレート出力、`related` 初期値設定。  
   - `migrate-from-libx`: スタブ実装（フェーズ3で詳細化）し、CLI 構造を先行整備。  
   - `validate`: フェーズ1-2のバリデーションモジュールを呼び出し。
5. **ログとエラーハンドリング**
   - 多段階ログ（info/warn/error）と JSON ログ出力（`--json`）を実装。  
   - エラー種別に応じた終了コード（成功0、ユーザー操作ミス1、内部エラー2 など）を定義。
6. **ドキュメント**
   - `docs/new-generator-plan/guides/docs-cli.md` に基本コマンドと例を記載。  
   - `DECISIONS.md` に CLI 基盤採用技術・フラグ規約を追加。

## 成果物
- `tools/docs-cli/`（または `packages/cli/`）のコードとテスト。
- `.docs-cli/config.json` テンプレート。
- バックアップユーティリティ (`src/cli/utils/backup.ts` など)。
- CLI ガイドとサンプルコマンド集。

## 完了条件
- 全コマンドが単体テストと統合テストを通過し、`.backups/` が意図どおり管理される。
- CI で `docs-cli` コマンドを非対話モードで実行できる。
- CLI を利用した基本フロー（プロジェクト作成→バージョン追加→言語追加→ドキュメント追加→バリデート）が実演可能。 
