# フェーズ2-4：ビルドパイプライン詳細計画

## 目的
- 単一ビルドコマンド (`pnpm build`) でレジストリ読み込みからサイト生成、検索インデックス作成まで完結させ、Cloudflare Pages へのデプロイと整合する出力を得る。
- フェーズ3以降の移行・検証タスクでも再利用できる堅牢なビルドフローとロギングを整備する。

## スコープ
- `prebuild → build → postbuild → search index` の段階的パイプライン設計。
- ビルド時の環境変数、設定ファイル、キャッシュ戦略の整理。
- 成功/失敗ログとレポート出力の統合。

## タスク
1. **ビルドステージ設計**
   - Prebuild: レジストリロード、バリデーション、テンポラリ出力ディレクトリの初期化。  
   - Build: Astro ビルド実行、ルーティング/レイアウト生成。  
   - Postbuild: サイトマップ、OG 画像生成、`_redirects` 出力。  
   - Search Index: Pagefind インデックス作成、サイズチェック。
2. **環境変数・設定**
   - `BUILD_ENV=local|staging|production` など環境ごとの挙動を定義。  
   - Cloudflare Pages 用の `CF_PAGES_URL`, `CF_PAGES_BRANCH` などを読み取り、リンクや canonical を書き換え。
3. **ログとレポート**
   - 各ステージでログを出力し、`dist/build-report.json` にサマリー（ページ数、ビルド時間、インデックスサイズ）を記録。  
   - 失敗時に詳細ログを `.logs/build-<timestamp>.txt` として保存。
4. **キャッシュ戦略**
   - Astro/Vite のキャッシュ、Pagefind インデックスキャッシュ、依存パッケージキャッシュ活用。  
   - CI/ローカルでのキャッシュパス統一とクリーンアップコマンド整備。
5. **テスト**
   - ビルドコマンドの統合テスト（小規模レジストリでのビルド成功確認）。  
   - ビルド時間・サイズのベンチマーク（目標値設定、リグレッション検知）。
6. **ドキュメント**
   - `docs/new-generator-plan/guides/build.md` にビルドパイプラインの処理フローと設定方法を記載。  
   - トラブルシューティング（キャッシュ破損、インデックス失敗、権限問題など）をまとめる。

## 成果物
- `scripts/build.ts`（もしくは `src/build/`）に実装されたビルドパイプライン。
- ビルドレポート出力とログ保存機構。
- ビルドガイドとトラブルシューティングドキュメント。

## 完了条件
- `pnpm build` が安定動作し、ログ／レポートが生成され、CI でも再現できる。
- Cloudflare Pages デプロイで必要なファイル（`_redirects`, `_headers`, `dist/pagefind/` など）が揃う。
- ビルド時間・生成サイズの目標値が達成され、リグレッションを検知できる仕組みが整っている。
