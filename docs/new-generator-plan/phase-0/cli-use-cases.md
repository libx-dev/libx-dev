# CLI ユースケース一覧（フェーズ0成果物）

新ジェネレーターで提供予定の `docs-cli`（仮称）の機能要件と想定フロー。フェーズ1 で MVP 実装対象を優先度づけするための基礎資料。

## 1. コマンド体系（案）
```
docs-cli
├── init-project
├── add-project
├── add-version
├── add-language
├── add-doc
├── migrate-from-libx
├── validate
├── build
├── dev
├── lint
└── info
```

## 2. ユースケース詳細

### 2.1 init-project
- **目的**: 新リポジトリを初期化し、レジストリ・コンテンツ・設定ファイルを生成。  
- **入力**: リポジトリ名、初期プロジェクト情報、デフォルト言語/バージョン。  
- **出力**: `registry/`、`content/`、`src/` の初期テンプレート。  
- **前提**: 空ディレクトリまたは初期化前状態。  
- **備考**: 既存 git リポジトリの場合は確認ダイアログ、`--force` で上書き。

### 2.2 add-project
- **目的**: 既存レジストリへ新しいドキュメントプロジェクトを追加。  
- **入力**: `projectId`, 表示名（多言語）、説明、タグ、アイコン、対応言語。  
- **出力**: レジストリ更新、`content/<docId>` 初期構造、テンプレート MDX。  
- **オプション**:
  - `--template <projectId>`: 既存プロジェクトをベースに構造をコピー。  
  - `--skip-content`: コンテンツディレクトリ生成を後回しにする。  
  - `--dry-run`: レジストリ差分のみ表示。

### 2.3 add-version
- **目的**: プロジェクトに新バージョンを追加し、必要なコンテンツを複製/初期化。  
- **入力**: `projectId`, `versionId`, 発売日、タグ、説明。  
- **出力**: レジストリ更新、`content` のバージョン別サブディレクトリ生成。  
- **オプション**:
  - `--from <versionId>`: 既存バージョンから内容をコピー。  
  - `--no-copy`: 空のコンテンツ構造のみ生成。  
  - `--interactive`: カテゴリ選択や翻訳対象を対話式で指定。

### 2.4 add-language
- **目的**: プロジェクトに新言語を追加。翻訳テンプレートや設定更新を自動化。  
- **入力**: `projectId`, `languageCode`, 表示名、説明。  
- **出力**: レジストリ更新、コンテンツディレクトリ生成、テンプレート MDX。  
- **オプション**:
  - `--template-lang <code>`: 参照言語の選択。  
  - `--auto-status <status>`: 翻訳ステータスを初期設定。  
  - `--skip-build`: ビルド検証を後で実行。  
- **特記事項**: ロールバック機構（バックアップ、失敗時に復元）を実装。

### 2.5 add-doc
- **目的**: カテゴリ内に新しいドキュメントを追加し、ID・スラッグ・ファイルを生成。  
- **入力**: `projectId`, `categoryId`, `docTitle`, `languages`.  
- **出力**: レジストリ `documents` 更新、`content/<docId>/<lang>.mdx` テンプレート。  
- **オプション**:
  - `--sync-key`: Tabs 等の共有要素に使用するキーを自動割り当て。  
  - `--draft`: 初期ステータスを `draft` に設定。

### 2.6 migrate-from-libx
- **目的**: libx-dev の既存構造からレジストリ・コンテンツを取り込み。  
- **入力**: 旧リポジトリパス、対象プロジェクト、オプション（`--preview`, `--fix-naming`）。  
- **出力**: レジストリ生成ファイル、差分レポート（HTML/Markdown/JSON）。  
- **フロー**:
  1. `project.config.json` / `projects.config.json` を解析。  
  2. カテゴリ・ドキュメント構造を `docId` ベースへ変換。  
  3. 翻訳状態、ライセンス情報を抽出。  
  4. レポートで未対応項目を提示。  
- **備考**: 部分移行にも対応（ `--projects <list>` ）。

### 2.7 validate
- **目的**: レジストリ・コンテンツの整合性検証を実行。CI と共有する。  
- **チェック例**:
  - JSON Schema 検証。  
  - コンテンツディレクトリ存在確認。  
  - 翻訳ステータスとファイル実体の一致。  
  - カテゴリ/ドキュメント参照整合性。  
- **オプション**: `--fix`（自動修正可能な項目）、`--strict`。

### 2.8 build
- **目的**: 単一ビルドパイプラインのローカル実行。  
- **機能**: レジストリ読込 → Astro ビルド → 検索インデックス生成 → サマリー出力。  
- **オプション**: `--local`（ベースパス無効化）、`--project <id>`（選択的ビルド）、`--analyze`（バンドル分析）。

### 2.9 dev
- **目的**: Astro 開発サーバー起動。レジストリ変更を監視しホットリロードを実現。  
- **特記事項**: CLI から `--open` や `--port` を指定。プロジェクトフィルタも検討。

### 2.10 lint
- **目的**: レジストリ/MDX/スタイルの一貫性チェック。  
- **内容**: Markdown lint、翻訳メモ（TODO/TBD）検出、用語集整合性などを拡張可能に。

### 2.11 info
- **目的**: 現在のレジストリ状況・統計を表示。  
- **表示項目**: プロジェクト数、バージョン・言語マトリクス、翻訳ステータス集計、未定義ライセンス、有効なビルド設定。  
- **利用シーン**: レポート、週次ステータス共有。

## 3. エラーハンドリング方針
- コマンド成功時/失敗時の統一フォーマット（JSON / テキスト）を選択できるようにする。  
- バックアップディレクトリ（`.backups/`）にロールバック対象ファイルを保存し、CLI で参照可能とする。  
- バリデーションエラーは CLI コード（EX_***）を割り当て、CI で判定しやすくする。

## 4. 優先度（フェーズ1導入対象）
| コマンド | 優先度 | 理由 |
| --- | --- | --- |
| `add-project`, `add-version`, `add-language`, `add-doc` | 高 | 既存スクリプト置き換えの最優先機能。 |
| `migrate-from-libx` | 高 | 移行フェーズのボトルネック解消。 |
| `validate` | 高 | スキーマ駆動の前提となる検証。 |
| `init-project` | 中 | 新規導入時に便利だが、初期段階ではテンプレート共有で代替可能。 |
| `build`, `dev` | 中 | `pnpm` 実行ラッパーとして後追い実装可。 |
| `lint`, `info` | 低 | フェーズ2〜3 での拡張要素。 |

## 5. 後続検討項目と現時点の方針
- **CLI のプラガブル化**  
  - MVP ではコアコマンドを内包し、フェーズ2で `plugins` ディレクトリ（Node ESM ローダー経由）を読み込める設計を検証する。  
  - プラグイン API は `docs-cli` 自身の JSON Schema を共有し、`package.json` の `docs-cli:plugin` フィールドで自動登録する案を第一候補とする。
- **GUI / TUI 導入**  
  - 初期は CLI + JSON 編集に注力し、フェーズ3以降に TUI（Ink など）を追加するか検討。GUI は当面対象外とし、必要性が高まった時点で外部ツール連携を検討する。
- **リモート API 連携**  
  - 翻訳サービスや CMS 連携はオプショナル機能としてプラグイン化を前提に設計。  
  - 具体候補（例: DeepL、Smartling）はフェーズ5の改善バックログに登録し、API キー管理方針と合わせて検討する。
- **CLI 出力の国際化**  
  - 当面は英語メッセージを基準とし、主要メッセージを `locales/en.json` に切り出しておく。  
  - 日本語など追加が必要になった時点で `--locale` オプションとメッセージバンドル切り替えを導入する。
- **CI 用設定注入の標準化**  
  - `.docs-cli/config.json` をリポジトリルートに設け、環境変数（`DOCS_CLI_CONFIG`, `DOCS_CLI_TOKEN` 等）を優先的に読み込むルールを採用。  
  - CI 実行例を `docs/new-generator-plan/examples/ci.md`（フェーズ1で作成予定）にて提示し、非対話実行を公式サポートする。
