# フェーズ1-4：テストと CI 詳細計画

## 目的
- レジストリと CLI の品質を自動的に担保するテストスイートおよび CI パイプラインを構築し、フェーズ2以降の機能追加時に回帰を防止する。
- 将来のマルチリポジトリ／外部コントリビューションにも対応できる標準的なビルド＆テストフローを整える。

## スコープ
- 単体テスト（ユニット）／統合テスト（CLI ワークフロー）／スナップショットテスト（エラーメッセージ）の設計。
- GitHub Actions（または相当 CI）での `lint → validate → build → test` ワークフロー構築。
- キャッシュ活用、Artifact 保存、失敗時ログ収集の設定。

## タスク
1. **テスト基盤整備**
   - Vitest / Jest の採用可否を評価し、CLI・スキーマ・ユーティリティで共通利用できる設定を作成。  
   - `registry/examples/` を用いたフィクスチャ管理とリセットロジックを実装。
2. **ユニットテスト**
   - スキーマ検証（正常系／異常系）。  
   - CLI コマンド単体の入力検証、エラーハンドリング、バックアップ生成。  
   - ユーティリティ（バックアップ、パス解決、ログフォーマットなど）。
3. **統合テスト**
   - `pnpm docs-cli add-project ...` から `validate` までの一連フローを E2E 的に実行するテストスクリプト。  
   - `--dry-run`, `--json`, `.docs-cli/config.json` 読み込みケースの確認。  
   - 既存スクリプト互換ラッパーの動作検証。
4. **スナップショットテスト**
   - バリデーションエラーのメッセージとコードが期待通り出力されるかスナップショット化。  
   - Pagefind メタ不整合、Glossary 重複等の代表的なエラーケースを登録。
5. **CI ワークフロー構築**
   - GitHub Actions で `pnpm install` キャッシュ、`pnpm lint`, `pnpm test`, `pnpm validate`, `pnpm build` を実行。  
   - 失敗時に `.backups/` とログを Artifact としてアップロード。  
   - `docs/new-generator-plan/examples/ci.md` にワークフロー YAML を掲載。
6. **ドキュメントとトレーニング**
   - テストポリシー（どのケースをユニット、統合、スナップショットに割り当てるか）を文書化。  
   - 新規テスト追加ガイド（命名規則、Fixture の使い方）をガイドに追記。

## 成果物
- テストスイート（ユニット／統合／スナップショット）。
- GitHub Actions ワークフロー (`.github/workflows/docs-cli.yml` 等)。
- 失敗時ログ収集・Artifacts 保存設定。
- テストポリシーガイドライン (`docs/new-generator-plan/guides/testing.md`)。

## 完了条件
- CI が安定稼働し、Pull Request 時に自動実行される。
- テストで主要フローがカバーされ、バグ検出時にテスト追加→再発防止ができる運用が整っている。
- ドキュメントが整備され、チームメンバーがテスト・CI 設定を理解し自己更新できる。
