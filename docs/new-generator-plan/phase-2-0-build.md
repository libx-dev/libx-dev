# フェーズ2：ビルド実装

## 概要
- 期間目安: 4週間
- レジストリ/CLI を利用して最終的な Astro サイトを 1 回のビルドで生成できるよう、ランタイムとビルドパイプラインを整備するフェーズ。

## 目的
- Astro ランタイムにレジストリデータを取り込み、ルーティング・ナビゲーション・レイアウトを自動生成する。
- 既存の UI/テーマパッケージを再利用し、新ジェネレーターでも統一した体験を提供する。
- Cloudflare Pages を想定したビルド出力とアセット配置を確立する。
- Pagefind ベースの静的検索、`related` メタによるレコメンド、`glossary` 表示などレジストリ項目を UI に反映する。
- npm 公開を想定した共有パッケージ導入方法（npm vs Git サブモジュール）を検証し、最終方針を決定する。

## 主な成果物
- `src/generator/` モジュール（レジストリロード、ルート生成、サイドバー生成、サイトマップ生成）。
- `src/runtime/` 内のページ/レイアウト/コンポーネント実装。
- UI/テーマ抽出資産のインポート設定とスタイルガイド。
- `pnpm build` による単一ビルドパイプライン（prebuild → build → postbuild → search index）と設定ファイル。
- 動作サンプル（サンプルプロジェクトを用いた実行結果とスクリーンショット）。
- Pagefind インデックス生成スクリプトと成果物（`dist/pagefind/`）。
- バージョン/言語切替、アクセスコントロール (`visibility`) を反映したルーティング確認レポート。

## 想定タスク
- Astro の Content Collections / 動的ルーティングとレジストリ連携の設計。
- ナビゲーション生成ロジックの実装とテスト（階層メニュー、バージョン/言語切り替え、visibility フィルタ）。
- UI/テーマ資産の移植と、必要な調整（CSS スコープ、アクセシビリティ対応、ダークモード統合）。
- Pagefind インデックス生成と `documents[].keywords/tags/related` 連携の実装。
- Cloudflare Pages 向けのアセット最適化、ルート設定（例: `_redirects`）、検索アセット配置。
- 新しい共有パッケージの導入パス検証（npm 版ベータ公開 or Git サブモジュール）と互換テスト。
- 初期パフォーマンステスト（ビルド時間、生成サイズ、Lighthouse + Pagefind サイズ）。

### タスクブレークダウン
- **ランタイム/ジェネレーター**
  - `src/generator` でルーティング/サイドバー/サイトマップ生成処理を実装。
  - Visibility（draft/internal）を考慮したフィルタリングロジック追加。
  - `documents[].related` を使った関連記事セクションの生成。
- **UI/テーマ統合**
  - `@docs/ui`, `@docs/theme`, `@docs/versioning`, `@docs/i18n` の npm 版 or サブモジュール導入検証。
  - Astro コンポーネントへのスタイル適用とアクセシビリティテスト。
  - Page レイアウトで Glossary 表示、VersionSelector、Language 切り替えを実装。
- **検索機能**
  - Pagefind インデックス生成スクリプト作成、`pnpm build` への統合。
  - 検索結果 UI 実装（ハイライト、タグ/言語ラベル表示）。
  - Pagefind 設定（除外パス、同義語、重み付け）のチューニング。
- **ビルドパイプライン**
  - `pnpm build` で prebuild → build → postbuild → search index のワークフロー整備。
  - Cloudflare Pages 用 `_redirects` とヘッダ設定の生成。
  - ビルド成果物検証（Lighthouse、Pagefind サイズ、パフォーマンスレポート）。
- **共有パッケージ検証**
  - npm 発行手順または Git サブモジュール導入手順のドキュメント化。
  - 既存アプリとの互換試験、Breaking Change リスト作成。
- **ドキュメント/デモ**
  - サンプルサイトのスクリーンショット・動画キャプチャ。
  - 検索・ナビゲーション利用ガイドのドラフト。

## 体制・ステークホルダー
- テックリード: 全体設計レビュー、ビルド成果物の品質確認。
- フロントエンドエンジニア: Astro 実装、UI/テーマ適用。
- インフラ担当（兼任可）: Cloudflare Pages 設定、CD フロー相談。
- QA リード: UI/UX 観点での初期レビュー、アクセシビリティ要件策定。

## 依存関係と前提
- フェーズ1までに CLI でレジストリ操作が可能になっている。
- UI/テーマ資産の抽出計画が確定し、必要なモジュールが利用可能。
- Cloudflare Pages で使用する環境変数やビルド条件が整理済み。

## リスクと緩和策
- Astro 側の制約で動的生成が複雑化 → 必要に応じて事前ビルド用の補助スクリプトを追加し、柔軟に対応。
- UI/テーマ資産の互換性問題 → カバレッジテストを行い、テーマ側を適宜メンテナンスする。
- パフォーマンス劣化 → ビルドプロファイルを定期計測し、キャッシュ戦略や分割ビルドオプションを検討。
- Pagefind インデックスサイズ肥大化 → keywords/tags の最適化と除外設定を導入。
- 共有パッケージ導入手段の確定遅延 → フェーズ2前半で npm 版 PoC を実施し、問題があればサブモジュールへ切り替える。

## 成功基準
- CLI で生成したサンプルデータを用いて `pnpm build` が成功し、全ページが想定通り出力される。
- 主要ページの Lighthouse スコアが既存 libx-dev と同等または上回る。
- Cloudflare Pages でのデプロイテストが成功し、ルーティング/アセットが正常動作する。
- Pagefind 検索と関連ドキュメント表示がレジストリのメタデータと一致する。
- Visibility 設定（draft/internal）がビルド結果に反映されている。

## メトリクスとチェックポイント
- ビルド成功率とビルド時間（ターゲット: 既存統合ビルドより短縮）。
- 主要ページのアクセシビリティ/パフォーマンス簡易スコア。
- UI コンポーネントの移植完了率（テスト済みコンポーネント数 / 総コンポーネント数）。
- 検索インデックス生成時間とサイズ、検索テストの成功率。
- npm 公開 (or サブモジュール) パッケージのフィードバック件数・対応状況。
