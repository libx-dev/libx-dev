---
/**
 * VersionSelector - バージョン切り替えコンポーネント
 * プロジェクトの全バージョンをドロップダウンで表示し、切り替え可能にします
 */
import { loadRegistry } from '@docs/generator';

interface Props {
  /** プロジェクトID */
  projectId: string;
  /** 現在のバージョン */
  currentVersion: string;
  /** 言語 */
  lang: string;
  /** 現在のスラッグ */
  slug: string;
}

const { projectId, currentVersion, lang, slug } = Astro.props;

// レジストリからプロジェクト情報を取得
const registry = loadRegistry('/Users/dolphilia/github/libx-dev/registry/docs.json');
const project = registry.projects.find(p => p.id === projectId);

if (!project) {
  console.error(`Project not found: ${projectId}`);
  return null;
}

// バージョン情報を整形
interface VersionInfo {
  id: string;
  name: string;
  status: string;
  isLatest: boolean;
  date: string;
  href: string;
}

const versions: VersionInfo[] = project.versions
  .map(v => ({
    id: v.id,
    name: typeof v.name === 'object' ? (v.name[lang] || v.name['en'] || v.name[Object.keys(v.name)[0]]) : v.name,
    status: v.status,
    isLatest: v.isLatest || false,
    date: v.date || '',
    href: `/${projectId}/${v.id}/${lang}/${slug}`
  }))
  .sort((a, b) => {
    // 最新版を最初に
    if (a.isLatest) return -1;
    if (b.isLatest) return 1;
    // リリース日でソート
    return new Date(b.date).getTime() - new Date(a.date).getTime();
  });
---

<div class="version-selector">
  <label for="version-select" class="version-label">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <polyline points="12 6 12 12 16 14"></polyline>
    </svg>
    バージョン:
  </label>
  <select
    id="version-select"
    class="version-select"
    onchange="window.location.href = this.value"
  >
    {versions.map(version => (
      <option
        value={version.href}
        selected={version.id === currentVersion}
      >
        {version.name}
        {version.isLatest && ' (最新)'}
        {version.status === 'deprecated' && ' (非推奨)'}
        {version.status === 'beta' && ' (ベータ)'}
      </option>
    ))}
  </select>
</div>

<style>
  .version-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
  }

  .version-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    white-space: nowrap;
  }

  .version-label svg {
    width: 16px;
    height: 16px;
    color: var(--color-primary);
  }

  .version-select {
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    background-color: var(--color-bg);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 12px;
    color: var(--color-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
  }

  .version-select:hover {
    border-color: var(--color-primary);
  }

  .version-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    .version-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239ca3af' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    }
  }

  @media (max-width: 768px) {
    .version-selector {
      padding: 0.5rem 0.75rem;
    }

    .version-label {
      font-size: 0.8125rem;
    }

    .version-select {
      font-size: 0.8125rem;
      padding: 0.375rem 1.75rem 0.375rem 0.625rem;
    }
  }
</style>
